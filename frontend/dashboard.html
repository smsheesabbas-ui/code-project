<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cashflow</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>

    <!-- Minimized Sidebar (expands on hover) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="9" fill="url(#logoGradD)"/>
                    <path d="M10 16 C10 11.58 13.58 8 18 8" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <path d="M22 16 C22 20.42 18.42 24 14 24" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <circle cx="18" cy="8" r="2.2" fill="white"/>
                    <circle cx="14" cy="24" r="2.2" fill="white"/>
                    <defs>
                        <linearGradient id="logoGradD" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#f97316"/>
                            <stop offset="100%" stop-color="#eab308"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="logo-text">Cashflow</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <a href="dashboard.html" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="transactions.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="2" x2="12" y2="22"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <span class="nav-text">Transactions</span>
                </a>
                <a href="entities.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span class="nav-text">Customers & Suppliers</span>
                </a>
                <a href="insights.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    <span class="nav-text">Insights</span>
                </a>
                <a href="assistant.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="nav-text">Assistant</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Data</span>
                <button class="nav-item" onclick="showCSVUploadModal()" style="background: none; border: none; text-align: left; width: 100%; padding: 12px 16px; display: flex; align-items: center; gap: 12px; color: #6b7280; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; cursor: pointer;">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <span class="nav-text">Import CSV</span>
                </button>
            </div>
        </nav>

        <div class="sidebar-footer">
            <!-- Home Button -->
            <a href="index.html" class="sidebar-home-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>Back to Home</span>
            </a>
            <div class="user-profile">
                <div class="user-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <div class="user-info">
                    <div class="user-name">Demo User</div>
                    <div class="user-email">demo@cashflow.app</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Dashboard</h1>
                <p class="page-description">Your financial overview at a glance</p>
            </div>
            <button class="btn btn-primary" onclick="showCSVUploadModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Import CSV
            </button>
        </div>

        <div class="dashboard-content">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Cash Balance</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="2" x2="12" y2="22"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <div class="kpi-value">$24,580</div>
                    <div class="kpi-change positive">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="18 15 12 9 6 15"/>
                        </svg>
                        <span>+12.5% from last month</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Revenue (This Month)</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                            <polyline points="17 6 23 6 23 12"/>
                        </svg>
                    </div>
                    <div class="kpi-value">$18,240</div>
                    <div class="kpi-change positive">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="18 15 12 9 6 15"/>
                        </svg>
                        <span>+8.2% from last month</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Expenses (This Month)</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
                            <polyline points="17 18 23 18 23 12"/>
                        </svg>
                    </div>
                    <div class="kpi-value">$12,450</div>
                    <div class="kpi-change negative">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        <span>+15.3% from last month</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Net Income</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <div class="kpi-value">$5,790</div>
                    <div class="kpi-change neutral">
                        <span>Profit margin: 31.7%</span>
                    </div>
                </div>
            </div>

            <!-- Alert Banner -->
            <div class="alert-banner warning">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                    <strong>Cashflow Alert:</strong> Based on current spending, you may run low on cash in 18 days.
                </div>
                <button class="alert-close">×</button>
            </div>

            <!-- Main Content Grid -->
            <div class="content-grid">
                <!-- Chart Section -->
                <div class="card chart-card">
                    <div class="card-header">
                        <h3>Revenue vs Expenses</h3>
                        <select class="period-selector">
                            <option>Last 6 months</option>
                            <option>Last 3 months</option>
                            <option>This year</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="card">
                    <div class="card-header">
                        <h3>Top Customers</h3>
                        <a href="entities.html" class="card-link">View all →</a>
                    </div>
                    <div class="list">
                        <div class="list-item">
                            <div class="list-item-main">
                                <span class="list-item-name">Acme Corp</span>
                                <span class="list-item-meta">42% of revenue</span>
                            </div>
                            <span class="list-item-value">$7,650</span>
                        </div>
                        <div class="list-item">
                            <div class="list-item-main">
                                <span class="list-item-name">TechStart Inc</span>
                                <span class="list-item-meta">28% of revenue</span>
                            </div>
                            <span class="list-item-value">$5,100</span>
                        </div>
                        <div class="list-item">
                            <div class="list-item-main">
                                <span class="list-item-name">Global Solutions</span>
                                <span class="list-item-meta">15% of revenue</span>
                            </div>
                            <span class="list-item-value">$2,730</span>
                        </div>
                    </div>
                </div>

                <!-- Top Suppliers -->
                <div class="card">
                    <div class="card-header">
                        <h3>Top Suppliers</h3>
                        <a href="entities.html" class="card-link">View all →</a>
                    </div>
                    <div class="list">
                        <div class="list-item">
                            <div class="list-item-main">
                                <span class="list-item-name">AWS</span>
                                <span class="list-item-meta">Cloud infrastructure</span>
                            </div>
                            <span class="list-item-value">$3,200</span>
                        </div>
                        <div class="list-item">
                            <div class="list-item-main">
                                <span class="list-item-name">Adobe</span>
                                <span class="list-item-meta">Software subscription</span>
                            </div>
                            <span class="list-item-value">$980</span>
                        </div>
                        <div class="list-item">
                            <div class="list-item-main">
                                <span class="list-item-name">Office Supplies Co</span>
                                <span class="list-item-meta">Operations</span>
                            </div>
                            <span class="list-item-value">$645</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Insights -->
                <div class="card insights-card">
                    <div class="card-header">
                        <h3>Recent Insights</h3>
                        <a href="insights.html" class="card-link">View all →</a>
                    </div>
                    <div class="insight-list">
                        <div class="insight-item">
                            <div class="insight-icon success">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="insight-content">
                                <div class="insight-title">Strong customer retention</div>
                                <div class="insight-meta">3 of your top 5 customers increased spending this month</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon warning">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                </svg>
                            </div>
                            <div class="insight-content">
                                <div class="insight-title">Software expenses increased 45%</div>
                                <div class="insight-meta">Review subscriptions—you may have overlapping tools</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/api.js"></script>
    <script>
        // ========================================
        // DEBUGGING: Force function availability
        // ========================================
        console.log('Dashboard script loading...');
        
        // Ensure upload functionality is available with enhanced debugging
        function showCSVUploadModal() {
            console.log('showCSVUploadModal called on dashboard - START');
            try {
                const uploadHTML = `
                    <div id="uploadModal" class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                        <div class="modal-card" style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h2>Import CSV Data</h2>
                                <p>Upload a file or paste CSV data directly</p>
                            </div>
                            <div class="modal-body">
                                <!-- Tab Navigation -->
                                <div class="tab-nav" style="display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px;">
                                    <button class="tab-btn active" onclick="showTab('file')" style="padding: 12px 20px; background: none; border: none; cursor: pointer; border-bottom: 2px solid #f97316; color: #f97316;">File Upload</button>
                                    <button class="tab-btn" onclick="showTab('paste')" style="padding: 12px 20px; background: none; border: none; cursor: pointer;">Paste CSV Data</button>
                                </div>
                                
                                <!-- File Upload Tab -->
                                <div id="file-tab" class="tab-content">
                                    <div class="upload-area" style="border: 2px dashed #d1d5db; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer;" onclick="document.getElementById('csvFile').click()">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        <p style="margin: 0; color: #6b7280;">Click to browse or drag and drop</p>
                                        <p style="margin: 8px 0 0; font-size: 14px; color: #9ca3af;">CSV files only</p>
                                    </div>
                                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                                    <div id="fileInfo" style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 6px; display: none;">
                                        <p style="margin: 0; font-weight: 500;">Selected file:</p>
                                        <p id="fileName" style="margin: 4px 0 0; color: #6b7280;"></p>
                                    </div>
                                </div>
                                
                                <!-- Paste Tab -->
                                <div id="paste-tab" class="tab-content" style="display: none;">
                                    <textarea id="csvPaste" placeholder="Paste your CSV data here..." style="width: 100%; height: 200px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                                    <p style="margin: 8px 0; font-size: 14px; color: #6b7280;">Format: Date,Description,Amount,Category</p>
                                </div>
                                
                                <div class="modal-actions" style="margin-top: 20px; text-align: right;">
                                    <button class="btn btn-outline" onclick="closeUploadModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 6px; margin-right: 10px; cursor: pointer;">Cancel</button>
                                    <button class="btn btn-primary" onclick="processImport()" style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer;">Import Data</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('Creating modal HTML...');
                document.body.insertAdjacentHTML('beforeend', uploadHTML);
                console.log('Modal inserted successfully');
                
            } catch (error) {
                console.error('Error in showCSVUploadModal:', error);
                alert('Error opening upload modal: ' + error.message);
            }
        }
        
        // Make function globally available
        window.showCSVUploadModal = showCSVUploadModal;
        
        function showTab(tabName) {
            document.getElementById('file-tab').style.display = 'none';
            document.getElementById('paste-tab').style.display = 'none';
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottom = 'none';
                btn.style.color = '#6b7280';
            });
            
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.style.borderBottom = '2px solid #f97316';
            event.target.style.color = '#f97316';
        }
        
        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            if (modal) modal.remove();
        }
        
        function processImport() {
            const fileTab = document.getElementById('file-tab');
            const pasteTab = document.getElementById('paste-tab');
            
            if (fileTab.style.display !== 'none') {
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a CSV file');
                    return;
                }
                
                uploadFile(file);
            } else {
                const csvData = document.getElementById('csvPaste').value.trim();
                
                if (!csvData) {
                    alert('Please paste CSV data');
                    return;
                }
                
                uploadPastedData(csvData);
            }
        }
        
        async function uploadFile(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('http://localhost:8000/api/v1/imports/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                alert('File uploaded successfully! ID: ' + result.id);
                closeUploadModal();
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }
        
        async function uploadPastedData(csvData) {
            try {
                const blob = new Blob([csvData], { type: 'text/csv' });
                const file = new File([blob], 'pasted_data.csv', { type: 'text/csv' });
                
                await uploadFile(file);
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard DOM loaded');
            
            const fileInput = document.getElementById('csvFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('fileInfo').style.display = 'block';
                        document.getElementById('fileName').textContent = file.name;
                    }
                });
            }
            
            // Verify function is available
            console.log('Function showCSVUploadModal available:', typeof showCSVUploadModal);
        });
        
        console.log('Dashboard script loaded completely');
    </script>
</body>
</html>
