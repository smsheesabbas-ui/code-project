<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights - Cashflow AI</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .insight-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .insight-card h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 18px;
        }
        
        .summary-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .recommendation-list {
            list-style: none;
            padding: 0;
        }
        
        .recommendation-list li {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .alert-item {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .alert-item.medium {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }
        
        .alert-item.low {
            background: #f0fdf4;
            border-left-color: #10b981;
        }
        
        .forecast-chart {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
        }
        
        .chart-placeholder {
            height: 300px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        
        .refresh-btn:hover {
            background: #2563eb;
        }
        
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .confidence-text {
            font-size: 12px;
            color: #6b7280;
            min-width: 40px;
        }
    </style>
</head>
<body>
    <!-- Minimized Sidebar (expands on hover) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="9" fill="url(#logoGradD)"/>
                    <path d="M10 16 C10 11.58 13.58 8 18 8" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <path d="M22 16 C22 20.42 18.42 24 14 24" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <circle cx="18" cy="8" r="2.2" fill="white"/>
                    <circle cx="14" cy="24" r="2.2" fill="white"/>
                    <defs>
                        <linearGradient id="logoGradD" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#f97316"/>
                            <stop offset="100%" stop-color="#eab308"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="logo-text">Cashflow</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <a href="dashboard.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                    </svg>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="transactions.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="2" x2="12" y2="22"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <span class="nav-text">Transactions</span>
                </a>
                <a href="entities.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span class="nav-text">Customers & Suppliers</span>
                </a>
                <a href="insights.html" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    <span class="nav-text">Insights</span>
                </a>
                <a href="assistant.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="nav-text">Assistant</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">Data</span>
                <button class="nav-item" onclick="showCSVUploadModal()" style="background: none; border: none; text-align: left; width: 100%; padding: 12px 16px; display: flex; align-items: center; gap: 12px; color: #6b7280; text-decoration: none; border-radius: 8px; transition: all 0.2s ease; cursor: pointer;">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <span class="nav-text">Import CSV</span>
                </button>
            </div>
        </nav>

        <div class="sidebar-footer">
            <!-- Home Button -->
            <a href="index.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                </svg>
                <span class="nav-text">Home</span>
            </a>
        </div>
    </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <h1>AI Insights & Intelligence</h1>
                    <p>Get AI-powered financial insights, forecasts, and recommendations</p>
                </div>
                <div class="header-actions">
                    <button class="refresh-btn" onclick="refreshAllInsights()">üîÑ Refresh</button>
                    <button class="refresh-btn" onclick="checkAlerts()">üîî Check Alerts</button>
                </div>
            </header>

            <div id="insightsContent">
                <div class="loading">
                    <p>Loading AI insights...</p>
                </div>
            </div>
        </main>

    <!-- Include API Integration -->
    <script src="js/api.js"></script>
    <script>
        // ========================================
        // UPLOAD FUNCTIONALITY
        // ========================================
        function showCSVUploadModal() {
            console.log('showCSVUploadModal called on insights');
            const uploadHTML = `
                <div id="uploadModal" class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                    <div class="modal-card" style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>Import CSV Data</h2>
                            <p>Upload a file or paste CSV data directly</p>
                        </div>
                        <div class="modal-body">
                            <!-- Tab Navigation -->
                            <div class="tab-nav" style="display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px;">
                                <button class="tab-btn active" onclick="showTab('file')" style="padding: 12px 20px; background: none; border: none; cursor: pointer; border-bottom: 2px solid #f97316; color: #f97316;">File Upload</button>
                                <button class="tab-btn" onclick="showTab('paste')" style="padding: 12px 20px; background: none; border: none; cursor: pointer;">Paste CSV Data</button>
                            </div>
                            
                            <!-- File Upload Tab -->
                            <div id="file-tab" class="tab-content">
                                <div class="upload-area" style="border: 2px dashed #d1d5db; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer;" onclick="document.getElementById('csvFile').click()">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    <p style="margin: 0; color: #6b7280;">Click to browse or drag and drop</p>
                                    <p style="margin: 8px 0 0; font-size: 14px; color: #9ca3af;">CSV files only</p>
                                </div>
                                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                                <div id="fileInfo" style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 6px; display: none;">
                                    <p style="margin: 0; font-weight: 500;">Selected file:</p>
                                    <p id="fileName" style="margin: 4px 0 0; color: #6b7280;"></p>
                                </div>
                            </div>
                            
                            <!-- Paste Tab -->
                            <div id="paste-tab" class="tab-content" style="display: none;">
                                <textarea id="csvPaste" placeholder="Paste your CSV data here..." style="width: 100%; height: 200px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                                <p style="margin: 8px 0; font-size: 14px; color: #6b7280;">Format: Date,Description,Amount,Category</p>
                            </div>
                            
                            <div class="modal-actions" style="margin-top: 20px; text-align: right;">
                                <button class="btn btn-outline" onclick="closeUploadModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 6px; margin-right: 10px; cursor: pointer;">Cancel</button>
                                <button class="btn btn-primary" onclick="processImport()" style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer;">Import Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', uploadHTML);
        }
        
        function showTab(tabName) {
            document.getElementById('file-tab').style.display = 'none';
            document.getElementById('paste-tab').style.display = 'none';
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottom = 'none';
                btn.style.color = '#6b7280';
            });
            
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.style.borderBottom = '2px solid #f97316';
            event.target.style.color = '#f97316';
        }
        
        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            if (modal) modal.remove();
        }
        
        function processImport() {
            const fileTab = document.getElementById('file-tab');
            const pasteTab = document.getElementById('paste-tab');
            
            if (fileTab.style.display !== 'none') {
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a CSV file');
                    return;
                }
                
                uploadFile(file);
            } else {
                const csvData = document.getElementById('csvPaste').value.trim();
                
                if (!csvData) {
                    alert('Please paste CSV data');
                    return;
                }
                
                uploadPastedData(csvData);
            }
        }
        
        async function uploadFile(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('http://localhost:8000/api/v1/imports/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
                const result = await response.json();
                alert('File uploaded successfully! ID: ' + result.id);
                closeUploadModal();
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }
        
        async function uploadPastedData(csvData) {
            try {
                const blob = new Blob([csvData], { type: 'text/csv' });
                const file = new File([blob], 'pasted_data.csv', { type: 'text/csv' });
                
                await uploadFile(file);
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('csvFile');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('fileInfo').style.display = 'block';
                        document.getElementById('fileName').textContent = file.name;
                    }
                });
            }
        });
        
        // ========================================
        // INSIGHTS PAGE FUNCTIONALITY
        // ========================================
        
        let insightsData = {
            summary: null,
            recommendations: [],
            forecast: null,
            alerts: []
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadAllInsights();
        });

        async function loadAllInsights() {
            try {
                // Show loading state
                showLoading();
                
                // Load all insights in parallel
                const [summary, recommendations, forecast, alerts] = await Promise.all([
                    IntelligenceAPI.getWeeklySummary(),
                    IntelligenceAPI.getRecommendations(),
                    IntelligenceAPI.getCashflowForecast(30),
                    IntelligenceAPI.getAlerts(20)
                ]);
                
                // Store data
                insightsData.summary = summary;
                insightsData.period_end = summary.period_end;
                insightsData.data = summary.data;
                insightsData.recommendations = recommendations.recommendations || [];
                insightsData.forecast = forecast;
                insightsData.alerts = alerts.alerts || [];
                
                // Always render insights - even demo data is valuable
                renderInsights();
                
            } catch (error) {
                console.error('Error loading insights:', error);
                // Show demo data with Gemini branding
                showDemoInsights();
            }
        }

        function showDemoInsights() {
            const content = document.getElementById('insightsContent');
            
            const demoHTML = `
                <div class="insight-grid">
                    <!-- Weekly Summary Demo -->
                    <div class="insight-card">
                        <h3>üìä Weekly AI Summary</h3>
                        <div class="summary-text">
                            <p><strong>Demo Mode:</strong> AI insights require GEMINI_API_KEY for full functionality.</p>
                            <p>Based on your recent transactions, you've maintained healthy cash flow with consistent revenue streams. Consider monitoring upcoming expenses in the Software & Subscriptions category.</p>
                        </div>
                        <small>Generated: ${new Date().toLocaleDateString()}</small>
                    </div>
                    
                    <!-- Key Metrics Demo -->
                    <div class="insight-card">
                        <h3>üí∞ Key Financial Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric">
                                <span class="metric-value">$12,450</span>
                                <span class="metric-label">Current Balance</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">$3,250</span>
                                <span class="metric-label">Weekly Revenue</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">$1,890</span>
                                <span class="metric-label">Weekly Expenses</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value">+$1,360</span>
                                <span class="metric-label">Net Cash Flow</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Customers Demo -->
                    <div class="insight-card">
                        <h3>üèÜ Top Customers This Week</h3>
                        <div class="list">
                            <div class="list-item">
                                <div class="list-item-main">
                                    <span class="list-item-name">Acme Corporation</span>
                                    <span class="list-item-meta">42% of revenue</span>
                                </div>
                                <span class="list-item-value">$1,365</span>
                            </div>
                            <div class="list-item">
                                <div class="list-item-main">
                                    <span class="list-item-name">TechStart Inc</span>
                                    <span class="list-item-meta">28% of revenue</span>
                                </div>
                                <span class="list-item-value">$910</span>
                            </div>
                            <div class="list-item">
                                <div class="list-item-main">
                                    <span class="list-item-name">Global Services Ltd</span>
                                    <span class="list-item-meta">15% of revenue</span>
                                </div>
                                <span class="list-item-value">$488</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations Demo -->
                    <div class="insight-card">
                        <h3>üí° AI Recommendations</h3>
                        <div class="recommendations">
                            <div class="recommendation-item">
                                <span class="rec-icon">üìà</span>
                                <div class="rec-content">
                                    <strong>Revenue Growth:</strong> Your revenue increased 15% this week. Consider reaching out to top customers for additional services.
                                </div>
                            </div>
                            <div class="recommendation-item">
                                <span class="rec-icon">‚ö†Ô∏è</span>
                                <div class="rec-content">
                                    <strong>Expense Monitoring:</strong> Software subscriptions increased 23%. Review unused subscriptions to optimize costs.
                                </div>
                            </div>
                            <div class="recommendation-item">
                                <span class="rec-icon">üéØ</span>
                                <div class="rec-content">
                                    <strong>Cash Flow:</strong> Strong positive cash flow. Consider investing surplus in short-term interest-bearing accounts.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Status Demo -->
                    <div class="insight-card">
                        <h3>üîî Alert Status</h3>
                        <div class="alert-status">
                            <div class="alert-item success">
                                <span class="alert-icon">‚úÖ</span>
                                <span>Cash Flow Healthy</span>
                            </div>
                            <div class="alert-item success">
                                <span class="alert-icon">‚úÖ</span>
                                <span>Customer Diversification Good</span>
                            </div>
                            <div class="alert-item warning">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <span>Monitor Subscription Costs</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="demo-notice">
                    <p><strong>Demo Mode:</strong> Set <code>GEMINI_API_KEY</code> in environment variables to enable full AI-powered insights and personalized recommendations.</p>
                </div>
            `;
            
            content.innerHTML = demoHTML;
        }

        function renderInsights() {
            const content = document.getElementById('insightsContent');
            
            let html = '';
            
            // Weekly Summary
            if (insightsData.summary) {
                html += `
                    <div class="insight-card">
                        <h3>üìä Google Gemini AI Summary</h3>
                        <div class="summary-text">
                            <p>${insightsData.summary}</p>
                            <small>Generated: ${new Date(insightsData.period_end).toLocaleDateString()}</small>
                        </div>
                    </div>
                `;
            }
            
            // Alerts Section
            if (insightsData.alerts.length > 0) {
                html += `
                    <div class="insight-card">
                        <h3>üö® Financial Alerts</h3>
                        <div class="alert-list">
                `;
                
                insightsData.alerts.forEach(alert => {
                    const severity = alert.severity || 'low';
                    html += `
                        <div class="alert-item ${severity}">
                            <strong>${alert.title}</strong>
                            <p>${alert.message}</p>
                            <small>${new Date(alert.created_at).toLocaleDateString()}</small>
                            ${!alert.acknowledged ? `<button class="refresh-btn" onclick="acknowledgeAlert('${alert.id}')">Acknowledge</button>` : '<span style="color: #10b981;">‚úì Acknowledged</span>'}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Recommendations
            if (insightsData.recommendations.length > 0) {
                html += `
                    <div class="insight-card">
                        <h3>üí° AI Recommendations</h3>
                        <ul class="recommendation-list">
                `;
                
                insightsData.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                
                html += `
                        </ul>
                        <small>Generated: ${new Date(insightsData.recommendations.generated_at).toLocaleDateString()}</small>
                    </div>
                `;
            }
            
            // Forecast
            if (insightsData.forecast) {
                const forecast = insightsData.forecast;
                
                if (forecast.status === 'success') {
                    const summary = forecast.forecast.summary;
                    html += `
                        <div class="forecast-chart">
                            <h3>üìà 30-Day Cashflow Forecast</h3>
                            <div class="confidence-meter">
                                <span>Confidence:</span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${(forecast.confidence_metrics?.overall_confidence || 0) * 100}%"></div>
                                </div>
                                <span class="confidence-text">${Math.round((forecast.confidence_metrics?.overall_confidence || 0) * 100)}%</span>
                            </div>
                            <div class="chart-placeholder">
                                <div>
                                    <strong>Forecast Summary</strong><br>
                                    Total Predicted: ${formatCurrency(summary.total_predicted)}<br>
                                    Average Daily: ${formatCurrency(summary.average_daily)}<br>
                                    Trend: ${summary.trend_direction}<br>
                                    <small>Based on ${forecast.data_points} transactions</small>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="insight-card">
                            <h3>üìà Cashflow Forecast</h3>
                            <p>${forecast.message || 'Insufficient data for forecasting'}</p>
                            <p><small>Need at least 60 days and 50 transactions for accurate forecasting</small></p>
                        </div>
                    `;
                }
            }
            
            // AI Tools
            html += `
                <div class="insights-grid">
                    <div class="insight-card">
                        <h3>ü§ñ Entity Extraction</h3>
                        <p>Extract company names from transaction descriptions using AI</p>
                        <input type="text" id="entityInput" placeholder="Enter transaction description..." style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #e5e7eb; border-radius: 4px;">
                        <button class="refresh-btn" onclick="extractEntity()">Extract Entity</button>
                        <div id="entityResult" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="insight-card">
                        <h3>üè∑Ô∏è Category Classification</h3>
                        <p>Classify transaction categories using AI</p>
                        <input type="text" id="categoryInput" placeholder="Enter transaction description..." style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #e5e7eb; border-radius: 4px;">
                        <input type="number" id="amountInput" placeholder="Amount" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #e5e7eb; border-radius: 4px;">
                        <button class="refresh-btn" onclick="classifyCategory()">Classify</button>
                        <div id="categoryResult" style="margin-top: 10px;"></div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        async function refreshAllInsights() {
            await loadAllInsights();
        }

        async function checkAlerts() {
            try {
                const result = await IntelligenceAPI.checkAlerts();
                if (result.alerts_found > 0) {
                    insightsData.alerts = result.alerts;
                    renderInsights();
                    alert(`Found ${result.alerts_found} new alerts!`);
                } else {
                    alert('No new alerts detected.');
                }
            } catch (error) {
                console.error('Error checking alerts:', error);
                alert('Failed to check alerts');
            }
        }

        async function acknowledgeAlert(alertId) {
            try {
                await IntelligenceAPI.acknowledgeAlert(alertId);
                // Refresh alerts
                const alerts = await IntelligenceAPI.getAlerts(20);
                insightsData.alerts = alerts.alerts || [];
                renderInsights();
            } catch (error) {
                console.error('Error acknowledging alert:', error);
                alert('Failed to acknowledge alert');
            }
        }

        async function extractEntity() {
            const input = document.getElementById('entityInput');
            const result = document.getElementById('entityResult');
            
            if (!input.value.trim()) {
                result.innerHTML = '<span style="color: #ef4444;">Please enter a description</span>';
                return;
            }
            
            try {
                result.innerHTML = '<span style="color: #6b7280;">Extracting...</span>';
                const response = await IntelligenceAPI.extractEntity(input.value);
                
                result.innerHTML = `
                    <strong>Extracted Entity:</strong> ${response.extracted_entity}<br>
                    <small>Confidence: ${response.confidence}</small>
                `;
            } catch (error) {
                result.innerHTML = `<span style="color: #ef4444;">Error: ${error.message}</span>`;
            }
        }

        async function classifyCategory() {
            const descInput = document.getElementById('categoryInput');
            const amountInput = document.getElementById('amountInput');
            const result = document.getElementById('categoryResult');
            
            if (!descInput.value.trim() || !amountInput.value) {
                result.innerHTML = '<span style="color: #ef4444;">Please enter description and amount</span>';
                return;
            }
            
            try {
                result.innerHTML = '<span style="color: #6b7280;">Classifying...</span>';
                const response = await IntelligenceAPI.classifyCategory(descInput.value, parseFloat(amountInput.value));
                
                result.innerHTML = `
                    <strong>Category:</strong> ${response.classified_category}<br>
                    <small>Confidence: ${response.confidence}</small>
                `;
            } catch (error) {
                result.innerHTML = `<span style="color: #ef4444;">Error: ${error.message}</span>`;
            }
        }

        function showLoading() {
            document.getElementById('insightsContent').innerHTML = `
                <div class="loading">
                    <p>Loading AI insights...</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('insightsContent').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
    </script>
</body>
</html>
